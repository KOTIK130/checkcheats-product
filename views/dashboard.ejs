<%- include('header') -%>

<div class="container">
  <div class="hero" style="padding: 40px 24px;">
    <h1 style="font-size: 2.5rem;"><i class="fas fa-chart-line"></i> Панель управления</h1>
    <p>Добро пожаловать, <%= user.username %>!</p>
  </div>

  <!-- Subscription Info Card -->
  <% if (user.subscriptionType && user.subscriptionType !== 'none') { %>
  <div class="card" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.1)); border-color: var(--primary);">
    <h3 style="margin-bottom: 16px;"><i class="fas fa-crown"></i> Статус подписки</h3>
    <div class="grid grid-3">
      <div>
        <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 4px;">UID</div>
        <div style="font-weight: 600; font-size: 1.1rem;"><%= user.uid || 'N/A' %></div>
      </div>
      <div>
        <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 4px;">Тип подписки</div>
        <div>
          <span class="badge badge-info">
            <%= user.subscriptionType === 'lifetime' ? 'Навсегда' : user.subscriptionType === '90days' ? '90 дней' : '30 дней' %>
          </span>
        </div>
      </div>
      <div>
        <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 4px;">Истекает</div>
        <div style="font-weight: 600; font-size: 1.1rem;">
          <%= user.subscriptionExpires ? new Date(user.subscriptionExpires).toLocaleDateString('ru-RU') : 'N/A' %>
        </div>
      </div>
    </div>
  </div>
  <% } else { %>
  <div class="card" style="background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3);">
    <div style="text-align: center;">
      <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--danger); margin-bottom: 16px;"></i>
      <h3 style="margin-bottom: 12px;">У вас нет активной подписки</h3>
      <p style="color: var(--text-secondary); margin-bottom: 20px;">Приобретите лицензионный ключ для доступа к CheckCheats</p>
      <a href="/products" class="btn"><i class="fas fa-shopping-cart"></i> Перейти к продуктам</a>
    </div>
  </div>
  <% } %>

  <!-- Activate Key Card -->
  <div class="card">
    <h3 style="margin-bottom: 16px;"><i class="fas fa-key"></i> Активировать лицензионный ключ</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; align-items: end;">
      <div class="form-group" style="margin-bottom: 0;">
        <label>Лицензионный ключ</label>
        <input type="text" id="licenseKey" class="form-control" placeholder="CC-XXXXXXXX-XXXXXXXX" style="text-transform: uppercase;">
      </div>
      <div class="form-group" style="margin-bottom: 0;">
        <label>HWID (Hardware ID)</label>
        <input type="text" id="hwid" class="form-control" placeholder="Введите HWID">
      </div>
      <button class="btn btn-primary" onclick="activateKey()"><i class="fas fa-check-circle"></i> Активировать</button>
    </div>
    <div id="activationResult"></div>
  </div>

  <!-- Sessions Card -->
  <div class="card">
    <h3 style="margin-bottom: 20px;"><i class="fas fa-network-wired"></i> Мои сессии сканирования</h3>
    
    <div style="margin-bottom: 20px;">
      <h4 style="margin-bottom: 12px;">Создать новую сессию</h4>
      <div style="display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: end;">
        <div class="form-group" style="margin-bottom: 0;">
          <label>ID подозреваемого</label>
          <input type="text" id="suspectId" class="form-control" placeholder="Введите ID или ник игрока">
        </div>
        <button class="btn btn-primary" onclick="createSession()"><i class="fas fa-plus-circle"></i> Создать сессию</button>
      </div>
      <div id="sessionResult"></div>
    </div>

    <% if (sessions && sessions.length > 0) { %>
    <h4 style="margin-bottom: 12px;">История сессий</h4>
    <table class="table">
      <thead>
        <tr>
          <th>Код сессии</th>
          <th>ID подозреваемого</th>
          <th>Статус</th>
          <th>Создана</th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody>
        <% sessions.forEach(s => { %>
        <tr>
          <td><code><%= s.code %></code></td>
          <td><%= s.suspectId %></td>
          <td>
            <span class="badge badge-<%= s.status === 'completed' ? 'success' : s.status === 'active' ? 'info' : 'warning' %>">
              <%= s.status %>
            </span>
          </td>
          <td><%= new Date(s.createdAt).toLocaleString('ru-RU') %></td>
          <td>
            <a href="/session/<%= s.code %>" class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.85rem;">
              <i class="fas fa-eye"></i> Просмотр
            </a>
          </td>
        </tr>
        <% }); %>
      </tbody>
    </table>
    <% } else { %>
    <p style="text-align: center; color: var(--text-secondary); padding: 20px;">Сессий пока нет. Создайте первую!</p>
    <% } %>
  </div>
</div>

<script>
async function activateKey() {
  const key = document.getElementById('licenseKey').value.trim();
  const hwid = document.getElementById('hwid').value.trim();
  
  if (!key || !hwid) {
    alert('Заполните все поля!');
    return;
  }
  
  try {
    const res = await fetch('/api/license/activate', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + getCookie('token')
      },
      body: JSON.stringify({ key, hwid })
    });
    
    const data = await res.json();
    
    if (res.ok) {
      document.getElementById('activationResult').innerHTML = 
        '<div class="alert alert-success" style="margin-top: 16px; padding: 12px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; color: #10b981;">' +
        '<i class="fas fa-check-circle"></i> Ключ успешно активирован! UID: ' + data.uid + 
        '<br>Обновите страницу чтобы увидеть изменения.' +
        '</div>';
      setTimeout(() => location.reload(), 2000);
    } else {
      document.getElementById('activationResult').innerHTML = 
        '<div class="alert alert-error" style="margin-top: 16px; padding: 12px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; color: #ef4444;">' +
        '<i class="fas fa-times-circle"></i> Ошибка: ' + data.error +
        '</div>';
    }
  } catch (err) {
    alert('Ошибка сервера');
  }
}

async function createSession() {
  const suspectId = document.getElementById('suspectId').value.trim();
  
  if (!suspectId) {
    alert('Введите ID подозреваемого');
    return;
  }
  
  try {
    const res = await fetch('/api/sessions/create', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + getCookie('token')
      },
      body: JSON.stringify({ suspectId })
    });
    
    const data = await res.json();
    
    if (res.ok) {
      document.getElementById('sessionResult').innerHTML = 
        '<div class="alert alert-success" style="margin-top: 16px; padding: 12px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; color: #10b981;">' +
        '<i class="fas fa-check-circle"></i> Сессия создана!<br>' +
        '<strong>Код сессии:</strong> <code style="font-size: 1.1rem; background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 4px;">' + data.code + '</code><br>' +
        '<small>Сообщите этот код игроку для подключения к проверке.</small>' +
        '</div>';
      setTimeout(() => location.reload(), 3000);
    } else {
      document.getElementById('sessionResult').innerHTML = 
        '<div class="alert alert-error" style="margin-top: 16px; padding: 12px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; color: #ef4444;">' +
        '<i class="fas fa-times-circle"></i> Ошибка: ' + data.error +
        '</div>';
    }
  } catch (err) {
    alert('Ошибка сервера');
  }
}

function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}
</script>

<%- include('footer') -%>