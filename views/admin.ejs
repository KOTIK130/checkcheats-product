<%- include(''header'') -%>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
.admin-container { max-width: 1400px; margin: 0 auto; padding: 24px; }
.admin-header { text-align: center; margin-bottom: 32px; }
.admin-header h1 { font-size: 2.5rem; font-weight: 800; margin-bottom: 8px; }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 32px; }
.stat-card { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 16px; padding: 24px; text-align: center; transition: transform 0.2s; }
.stat-card:hover { transform: translateY(-4px); }
.stat-icon { font-size: 3rem; margin-bottom: 12px; background: linear-gradient(135deg, var(--accent-start), var(--accent-end)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.stat-value { font-size: 2rem; font-weight: 700; margin-bottom: 4px; }
.stat-label { color: var(--text-secondary); font-size: 0.9rem; }

.action-section { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 16px; padding: 24px; margin-bottom: 24px; }
.action-section h3 { margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
.action-section h3 i { color: var(--accent-start); }

.form-group { margin-bottom: 16px; }
.form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
.form-group input, .form-group select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--card-border); background: rgba(14, 27, 51, 0.6); color: var(--text-primary); }
.form-group input:focus, .form-group select:focus { outline: none; border-color: var(--accent-start); }

.btn-group { display: flex; gap: 12px; flex-wrap: wrap; }
.key-display { background: rgba(14, 27, 51, 0.8); border: 2px solid var(--accent-start); border-radius: 8px; padding: 16px; margin-top: 16px; }
.key-item { background: rgba(26, 38, 62, 0.5); padding: 8px 12px; border-radius: 6px; margin: 4px 0; font-family: monospace; display: flex; justify-content: space-between; align-items: center; }
.key-item .key-text { flex: 1; }
.btn-copy { padding: 6px 12px; font-size: 0.85rem; }

.users-table { width: 100%; border-collapse: collapse; margin-top: 16px; }
.users-table th { background: var(--card-bg); padding: 12px; text-align: left; font-weight: 600; border-bottom: 2px solid var(--card-border); }
.users-table td { padding: 12px; border-bottom: 1px solid var(--card-border); }
.users-table tr:hover { background: rgba(26, 38, 62, 0.3); }
.badge { padding: 4px 10px; border-radius: 12px; font-size: 0.85rem; font-weight: 500; }
.badge-admin { background: linear-gradient(135deg, #ff6b6b, #ff8e53); }
.badge-moderator { background: linear-gradient(135deg, #4ecdc4, #44a08d); }
.badge-user { background: linear-gradient(135deg, #667eea, #764ba2); }
.badge-lifetime { background: linear-gradient(135deg, #f093fb, #f5576c); }
.badge-90days { background: linear-gradient(135deg, #4facfe, #00f2fe); }
.badge-30days { background: linear-gradient(135deg, #43e97b, #38f9d7); }
.badge-none { background: rgba(160, 174, 192, 0.3); }

.search-result { background: rgba(26, 38, 62, 0.5); border: 1px solid var(--card-border); border-radius: 12px; padding: 20px; margin-top: 16px; }
.search-result h4 { margin-bottom: 16px; color: var(--accent-end); }
.info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
.info-item { background: rgba(14, 27, 51, 0.6); padding: 12px; border-radius: 8px; }
.info-label { color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 4px; }
.info-value { font-weight: 600; font-size: 1.1rem; }
</style>

<div class="admin-container">
  <div class="admin-header">
    <h1><i class="fas fa-shield-alt"></i> Панель администратора</h1>
    <p style="color: var(--text-secondary);">Управление пользователями и лицензиями CheckCheats</p>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon"><i class="fas fa-users"></i></div>
      <div class="stat-value"><%= users.length %></div>
      <div class="stat-label">Всего пользователей</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon"><i class="fas fa-network-wired"></i></div>
      <div class="stat-value"><%= stats.totalSessions %></div>
      <div class="stat-label">Всего сессий</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
      <div class="stat-value"><%= stats.activeSessions %></div>
      <div class="stat-label">Активные сессии</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon"><i class="fas fa-search"></i></div>
      <div class="stat-value"><%= stats.totalScans %></div>
      <div class="stat-label">Проведено сканирований</div>
    </div>
  </div>

  <div class="action-section">
    <h3><i class="fas fa-key"></i> Генерация лицензионных ключей</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 12px; align-items: end;">
      <div class="form-group" style="margin-bottom: 0;">
        <label>Тип подписки</label>
        <select id="keyType">
          <option value="30days">30 дней</option>
          <option value="90days">90 дней</option>
          <option value="lifetime">Навсегда (Lifetime)</option>
        </select>
      </div>
      <div class="form-group" style="margin-bottom: 0;">
        <label>Количество</label>
        <input type="number" id="keyQuantity" value="1" min="1" max="100">
      </div>
      <div style="padding-top: 30px;">
        <button class="btn" onclick="generateKeys()"><i class="fas fa-plus-circle"></i> Сгенерировать ключи</button>
      </div>
    </div>
    <div id="generatedKeys"></div>
  </div>

  <div class="action-section">
    <h3><i class="fas fa-search"></i> Поиск пользователя по UID</h3>
    <div style="display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: end;">
      <div class="form-group" style="margin-bottom: 0;">
        <label>Введите UID</label>
        <input type="text" id="searchUid" placeholder="UID-XXXXXXXXXXXX">
      </div>
      <button class="btn" onclick="searchByUid()"><i class="fas fa-search"></i> Найти</button>
    </div>
    <div id="searchResult"></div>
  </div>

  <div class="action-section">
    <h3><i class="fas fa-users-cog"></i> Управление пользователями</h3>
    <div style="overflow-x: auto;">
      <table class="users-table">
        <thead>
          <tr>
            <th>Пользователь</th>
            <th>Email</th>
            <th>UID</th>
            <th>Роль</th>
            <th>Подписка</th>
            <th>Истекает</th>
            <th>Действия</th>
          </tr>
        </thead>
        <tbody>
          <% users.forEach(u => { %>
          <tr>
            <td><strong><%= u.username %></strong></td>
            <td><%= u.email %></td>
            <td><code><%= u.uid || ''N/A'' %></code></td>
            <td>
              <span class="badge badge-<%= u.role %>"><%= u.role %></span>
            </td>
            <td>
              <span class="badge badge-<%= u.subscriptionType || ''none'' %>">
                <%= u.subscriptionType === ''lifetime'' ? ''Навсегда'' : u.subscriptionType === ''90days'' ? ''90 дней'' : u.subscriptionType === ''30days'' ? ''30 дней'' : ''Нет'' %>
              </span>
            </td>
            <td>
              <%= u.subscriptionExpires ? new Date(u.subscriptionExpires).toLocaleDateString(''ru-RU'') : ''-'' %>
            </td>
            <td>
              <div class="btn-group">
                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.85rem;" onclick="resetHwid(''<%= u._id %>'', ''<%= u.username %>'')">
                  <i class="fas fa-redo"></i> Сбросить HWID
                </button>
                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.85rem; background: #ff6b6b;" onclick="deleteUser(''<%= u._id %>'', ''<%= u.username %>'')">
                  <i class="fas fa-trash"></i> Удалить
                </button>
              </div>
            </td>
          </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
async function generateKeys() {
  const type = document.getElementById(''keyType'').value;
  const quantity = document.getElementById(''keyQuantity'').value;
  
  try {
    const res = await fetch(''/api/admin/generate-key'', {
      method: ''POST'',
      headers: { ''Content-Type'': ''application/json'' },
      body: JSON.stringify({ type, quantity })
    });
    
    const data = await res.json();
    
    if (res.ok) {
      let html = ''<div class="key-display"><h4 style="margin-bottom: 12px;">✅ Сгенерировано ключей: '' + data.keys.length + ''</h4>'';
      data.keys.forEach(key => {
        html += ''<div class="key-item"><span class="key-text">'' + key + ''</span><button class="btn btn-copy" onclick="copyKey(\'''''' + key + ''\'''')"><i class="fas fa-copy"></i> Копировать</button></div>'';
      });
      html += ''</div>'';
      document.getElementById(''generatedKeys'').innerHTML = html;
    } else {
      alert(''Ошибка: '' + data.error);
    }
  } catch (err) {
    alert(''Ошибка сервера'');
  }
}

function copyKey(key) {
  navigator.clipboard.writeText(key);
  alert(''Ключ скопирован: '' + key);
}

async function searchByUid() {
  const uid = document.getElementById(''searchUid'').value.trim();
  
  if (!uid) {
    alert(''Введите UID'');
    return;
  }
  
  try {
    const res = await fetch(''/api/admin/search-uid/'' + uid);
    const data = await res.json();
    
    if (res.ok) {
      const u = data.user;
      const subExpires = u.subscriptionExpires ? new Date(u.subscriptionExpires).toLocaleDateString(''ru-RU'') : ''Нет'';
      const subType = u.subscriptionType === ''lifetime'' ? ''Навсегда'' : u.subscriptionType === ''90days'' ? ''90 дней'' : u.subscriptionType === ''30days'' ? ''30 дней'' : ''Нет подписки'';
      
      let html = ''<div class="search-result">'';
      html += ''<h4>👤 Найден пользователь: '' + u.username + ''</h4>'';
      html += ''<div class="info-grid">'';
      html += ''<div class="info-item"><div class="info-label">Email</div><div class="info-value">'' + u.email + ''</div></div>'';
      html += ''<div class="info-item"><div class="info-label">UID</div><div class="info-value">'' + (u.uid || ''N/A'') + ''</div></div>'';
      html += ''<div class="info-item"><div class="info-label">HWID</div><div class="info-value">'' + (u.hwid || ''Не установлен'') + ''</div></div>'';
      html += ''<div class="info-item"><div class="info-label">Роль</div><div class="info-value">'' + u.role + ''</div></div>'';
      html += ''<div class="info-item"><div class="info-label">Подписка</div><div class="info-value">'' + subType + ''</div></div>'';
      html += ''<div class="info-item"><div class="info-label">Истекает</div><div class="info-value">'' + subExpires + ''</div></div>'';
      html += ''</div></div>'';
      
      document.getElementById(''searchResult'').innerHTML = html;
    } else {
      document.getElementById(''searchResult'').innerHTML = ''<div class="search-result" style="border-color: #ff6b6b;"><h4>❌ Пользователь не найден</h4></div>'';
    }
  } catch (err) {
    alert(''Ошибка сервера'');
  }
}

async function resetHwid(userId, username) {
  if (!confirm(''Сбросить HWID для пользователя '' + username + ''?'')) return;
  
  try {
    const res = await fetch(''/api/admin/reset-hwid/'' + userId, { method: ''POST'' });
    const data = await res.json();
    
    if (res.ok) {
      alert(''✅ HWID успешно сброшен для '' + username);
      location.reload();
    } else {
      alert(''Ошибка: '' + data.error);
    }
  } catch (err) {
    alert(''Ошибка сервера'');
  }
}

async function deleteUser(userId, username) {
  if (!confirm(''УДАЛИТЬ пользователя '' + username + ''? Это действие необратимо!'')) return;
  
  try {
    const res = await fetch(''/api/admin/delete-user/'' + userId, { method: ''POST'' });
    const data = await res.json();
    
    if (res.ok) {
      alert(''✅ Пользователь '' + username + '' удален'');
      location.reload();
    } else {
      alert(''Ошибка: '' + data.error);
    }
  } catch (err) {
    alert(''Ошибка сервера'');
  }
}
</script>

<%- include(''footer'') -%>
